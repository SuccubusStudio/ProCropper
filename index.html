<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Cropper V8.3 - Video Master</title>
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --depth-base: #020205;
            --depth-purple: #0f0725;
            --depth-blue: #050b24;
            --glass-bg: rgba(0, 0, 0, 0.45);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.3);
            --text: rgba(255, 255, 255, 0.55);
            --text-bright: #ffffff;
            --panel-inner: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--depth-base);
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
            color: var(--text);
        }

        /* Dynamic Background */
        .mesh-bg {
            position: fixed;
            inset: -50%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 30%, var(--depth-purple) 0, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--depth-blue) 0, transparent 50%),
                linear-gradient(135deg, #000 0%, #050512 100%);
            filter: blur(60px);
            animation: deepFlow 25s infinite alternate ease-in-out;
        }

        @keyframes deepFlow {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        #ambient-bg {
            position: absolute;
            inset: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            filter: blur(100px) saturate(1.8);
            opacity: 0;
            transition: opacity 2s ease;
        }

        #toast {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: #000;
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 800;
            font-size: 10px;
            letter-spacing: 2px;
            display: none;
            z-index: 9999;
            box-shadow: 0 15px 40px var(--accent-glow);
            text-transform: uppercase;
        }

        .app-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .toolbar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 15px 30px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            background: var(--glass-bg);
            box-sizing: border-box;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label {
            font-size: 8px;
            color: rgba(255,255,255,0.3);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1.5px;
        }

        .inputs-row {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--panel-inner);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            min-height: 36px;
        }

        /* Custom Select */
        .custom-select {
            position: relative;
            min-width: 140px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
        }
        .select-trigger { display: flex; justify-content: space-between; align-items: center; }
        .select-trigger:after {
            content: ''; border: solid var(--accent); border-width: 0 1.5px 1.5px 0;
            display: inline-block; padding: 3px; transform: rotate(45deg);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 15px);
            left: -10px; right: -10px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            display: none;
            z-index: 200;
            padding: 8px 0;
        }
        .custom-select.open .select-options { display: block; }
        .option { padding: 8px 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .option:hover { background: rgba(0, 242, 255, 0.1); color: var(--accent); }
        .option.selected { color: var(--accent); font-weight: 800; }

        input { background: transparent; border: none; color: #fff; width: 45px; text-align: center; font-weight: 600; font-size: 13px; outline: none; font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button { display: none; }
        input:focus { color: var(--accent); }

        .btn-icon {
            background: rgba(255,255,255,0.06); border: none; width: 32px; height: 32px;
            border-radius: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text); transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .btn-icon.active { color: var(--accent); background: rgba(0, 242, 255, 0.15); border: 1px solid rgba(0, 242, 255, 0.2); }

        /* Main Stage */
        .main-stage {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #dropzone {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(0,0,0,0.2);
            /* 防止單擊時觸發文字選取 */
            user-select: none;
        }
        #dropzone.hidden { display: none; }
        
        .upload-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 40px 60px;
            border-radius: 25px;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-card:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.08); transform: translateY(-5px); }

        .img-container { width: 100%; height: 100%; display: none; }
        #image { max-width: 100%; max-height: 100%; display: block; }

        /* Footer */
        .footer-bar {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            z-index: 100;
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            background: var(--glass-bg);
            border-top: 1px solid var(--glass-border);
        }

        .video-ui {
            padding: 12px 30px;
            display: none;
            flex-direction: column;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .time-row { display: flex; align-items: center; gap: 20px; }
        .time-display { font-family: monospace; font-size: 11px; color: var(--accent); min-width: 90px; letter-spacing: 1px; }
        input[type="range"] { flex: 1; accent-color: var(--accent); cursor: pointer; height: 4px; }

        .frame-nav { display: flex; justify-content: center; gap: 8px; }
        .btn-frame {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text); padding: 5px 12px; border-radius: 7px; font-size: 9px;
            font-weight: 800; cursor: pointer; text-transform: uppercase;
        }
        .btn-frame:hover { border-color: var(--accent); color: #fff; background: rgba(0, 242, 255, 0.1); }

        .action-row { padding: 18px 40px; display: flex; justify-content: center; gap: 15px; }
        .btn-main {
            padding: 12px 35px; border-radius: 14px; font-weight: 800; font-size: 10px;
            letter-spacing: 1.5px; text-transform: uppercase; cursor: pointer; transition: 0.3s;
        }
        .btn-copy { background: #fff; color: #000; border: none; }
        .btn-copy:hover { background: var(--accent); box-shadow: 0 10px 30px var(--accent-glow); transform: translateY(-2px); }
        .btn-dl { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid var(--glass-border); }
        .btn-dl:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); }

        /* Cropper UI Customization */
        .cropper-view-box { outline: 1px solid var(--accent); }
        .cropper-point { background-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .cropper-face { background-color: transparent; }
        .cropper-modal { background-color: #000; opacity: 0.6; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>
<div id="toast">ACTION COMPLETED</div>

<div class="app-container">
    <div id="ambient-bg"></div>

    <header class="toolbar">
        <div class="input-group">
            <label>Aspect Ratio</label>
            <div class="inputs-row">
                <div class="custom-select" id="ratioSelect">
                    <div class="select-trigger" id="selectValue">16:9 HD</div>
                    <div class="select-options">
                        <div class="option" data-value="custom">Free Form</div>
                        <div class="option" data-value="1:1">1:1 Square</div>
                        <div class="option" data-value="4:3">4:3 Classic</div>
                        <div class="option selected" data-value="16:9">16:9 HD</div>
                        <div class="option" data-value="21:9">21:9 Cinema</div>
                        <div class="option" data-value="9:16">9:16 Portrait</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>Dimensions (W / H)</label>
            <div class="inputs-row">
                <input type="number" id="aspW" value="16" step="0.1">
                <button class="btn-icon" id="swapBtn" title="Swap Width/Height">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 16l-4-4 4-4M17 8l4 4-4 4"/><path d="M3 12h18"/></svg>
                </button>
                <input type="number" id="aspH" value="9" step="0.1">
                <button class="btn-icon active" id="lockBtn" title="Lock Ratio">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg>
                </button>
            </div>
        </div>

        <div class="input-group">
            <label>Pixels (W / H)</label>
            <div class="inputs-row">
                <input type="number" id="pxW" placeholder="W">
                <button class="btn-icon" id="snapBtn" title="Snap to 16px Grid">
                    <span style="font-size:9px;font-weight:900">16</span>
                </button>
                <input type="number" id="pxH" placeholder="H">
            </div>
        </div>

        <div class="input-group">
            <label>Transform</label>
            <div class="inputs-row">
                <button class="btn-icon" id="rotateLeft" title="Rotate Left">↺</button>
                <button class="btn-icon" id="flipX" title="Flip Horizontal">↔</button>
                <button class="btn-icon" id="flipY" title="Flip Vertical">↕</button>
            </div>
        </div>
    </header>

    <main class="main-stage">
        <div id="dropzone">
            <div class="upload-card">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <p style="font-size: 10px; letter-spacing: 2px; font-weight: 800; color: #fff;">PASTE, DRAG OR DOUBLE CLICK</p>
            </div>
        </div>
        <div class="img-container" id="imgBox">
            <img id="image">
        </div>
        <video id="videoSource" style="display:none;"></video>
    </main>

    <footer class="footer-bar">
        <div class="video-ui" id="videoUI">
            <div class="time-row">
                <div class="time-display" id="timeDisplay">00:00.000</div>
                <input type="range" id="timeline" step="0.001" value="0">
            </div>
            <div class="frame-nav">
                <!-- 移除 +/- 10 FR 按鈕，只保留逐幀 -->
                <button class="btn-frame" onclick="stepFrame(-1)">PREV FR</button>
                <button class="btn-frame" onclick="stepFrame(1)">NEXT FR</button>
            </div>
        </div>
        <div class="action-row">
            <button class="btn-main btn-copy" id="copyBtn">Copy to Clipboard</button>
            <button class="btn-main btn-dl" id="dlBtn">Save Image</button>
            <input type="file" id="fileInput" hidden accept="image/*,video/mp4,video/quicktime">
        </div>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const video = document.getElementById('videoSource'), 
          image = document.getElementById('image'),
          imgBox = document.getElementById('imgBox'), 
          videoUI = document.getElementById('videoUI'),
          ambientBg = document.getElementById('ambient-bg'),
          timeline = document.getElementById('timeline'),
          timeDisplay = document.getElementById('timeDisplay'),
          dropzone = document.getElementById('dropzone'), 
          fileInput = document.getElementById('fileInput'),
          pxW = document.getElementById('pxW'), pxH = document.getElementById('pxH'),
          aspW = document.getElementById('aspW'), aspH = document.getElementById('aspH'),
          lockBtn = document.getElementById('lockBtn'), 
          swapBtn = document.getElementById('swapBtn'),
          snapBtn = document.getElementById('snapBtn'),
          ratioSelect = document.getElementById('ratioSelect'),
          selectValue = document.getElementById('selectValue');

    let cropper, isSnap16 = false, isRatioLocked = true;
    let isInternalUpdate = false;
    // 記錄最後一次合法的螢幕裁切框大小 (寬度/高度)
    let fixedCropBoxDim = null; 
    
    // 將 FPS 設定為 60，讓步進更細緻，解決「不是真正逐幀」的感覺
    const fps = 60;

    // --- Core Interaction Logic ---

    [aspW, aspH].forEach(input => {
        input.addEventListener('input', () => {
            if (!cropper) return;
            selectValue.innerText = "CUSTOM";
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            isRatioLocked = true;
            lockBtn.classList.add('active');
            updateCropperRatio();
        });
    });

    [pxW, pxH].forEach(input => {
        input.addEventListener('change', () => {
            if (!cropper || isInternalUpdate) return;
            isRatioLocked = false;
            lockBtn.classList.remove('active');
            selectValue.innerText = "FREE FORM";
            updateCropperRatio();
            const data = cropper.getData();
            cropper.setData({
                width: parseFloat(pxW.value) || data.width,
                height: parseFloat(pxH.value) || data.height
            });
            setTimeout(recordCropBoxDim, 100);
        });
    });

    // --- UI Event Handlers ---

    ratioSelect.onclick = (e) => { ratioSelect.classList.toggle('open'); e.stopPropagation(); };
    document.querySelectorAll('.option').forEach(option => {
        option.onclick = function() {
            const val = this.getAttribute('data-value');
            selectValue.innerText = this.innerText;
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            if (val === "custom") {
                isRatioLocked = false; lockBtn.classList.remove('active');
            } else {
                const [w, h] = val.split(':').map(Number);
                aspW.value = w; aspH.value = h;
                isRatioLocked = true; lockBtn.classList.add('active');
            }
            updateCropperRatio();
        };
    });
    window.onclick = () => ratioSelect.classList.remove('open');

    swapBtn.onclick = () => {
        const temp = aspW.value;
        aspW.value = aspH.value;
        aspH.value = temp;
        selectValue.innerText = "CUSTOM";
        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        updateCropperRatio();
    };

    function updateCropperRatio() {
        if (cropper) {
            cropper.setAspectRatio(isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN);
            setTimeout(recordCropBoxDim, 100);
        }
    }

    function recordCropBoxDim() {
        if (cropper) {
            fixedCropBoxDim = cropper.getCropBoxData();
        }
    }

    function initCropper() {
        if(cropper) cropper.destroy();
        
        cropper = new Cropper(image, {
            viewMode: 1, 
            dragMode: 'move', 
            cropBoxMovable: true, 
            cropBoxResizable: true, 
            toggleDragModeOnDblclick: false, 
            autoCropArea: 0.65,
            center: true, 
            background: false, 
            responsive: true,
            restore: false,
            
            ready() {
                const containerData = cropper.getContainerData();
                const toolbarH = document.querySelector('.toolbar').offsetHeight;
                const footerH = document.querySelector('.footer-bar').offsetHeight;
                const visibleHeight = containerData.height - toolbarH - footerH;
                const canvasData = cropper.getCanvasData();
                
                if (canvasData.height < visibleHeight) {
                    cropper.zoomTo(visibleHeight / canvasData.naturalHeight);
                }
                
                recordCropBoxDim();
            },
            
            aspectRatio: isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN,
            
            crop(e) { 
                if (document.activeElement !== pxW && document.activeElement !== pxH) {
                    isInternalUpdate = true;
                    pxW.value = Math.round(e.detail.width); 
                    pxH.value = Math.round(e.detail.height);
                    isInternalUpdate = false;
                }
            },
            
            cropend() {
                if (isSnap16) applySnap16();
                recordCropBoxDim();
            },

            zoom(e) {
                if (!fixedCropBoxDim) return;

                const newRatio = e.detail.ratio;
                const naturalWidth = cropper.getImageData().naturalWidth;
                const naturalHeight = cropper.getImageData().naturalHeight;
                const newCanvasWidth = naturalWidth * newRatio;
                const newCanvasHeight = naturalHeight * newRatio;

                let targetWidth = fixedCropBoxDim.width;
                let targetHeight = fixedCropBoxDim.height;

                if (newCanvasWidth < targetWidth) { targetWidth = newCanvasWidth; }
                if (newCanvasHeight < targetHeight) { targetHeight = newCanvasHeight; }

                setTimeout(() => {
                    let destLeft = fixedCropBoxDim.left;
                    let destTop = fixedCropBoxDim.top;
                    
                    const currentCanvas = cropper.getCanvasData();
                    
                    if (targetWidth < fixedCropBoxDim.width - 0.5) { destLeft = currentCanvas.left; }
                    if (targetHeight < fixedCropBoxDim.height - 0.5) { destTop = currentCanvas.top; }

                    cropper.setCropBoxData({
                        width: targetWidth,
                        height: targetHeight,
                        left: destLeft,
                        top: destTop
                    });
                }, 0);
            }
        });
    }

    window.addEventListener('resize', () => { if (cropper) cropper.resize(); });

    function applySnap16() {
        if (!cropper) return;
        const data = cropper.getData();
        let newW = Math.round(data.width / 16) * 16;
        let newH = isRatioLocked 
            ? Math.round((newW / (parseFloat(aspW.value)/parseFloat(aspH.value))) / 16) * 16 
            : Math.round(data.height / 16) * 16;
        cropper.setData({ width: newW, height: newH });
    }

    // --- File Handling & Utilities ---

    function handleFile(file) {
        if (!file) return;
        const url = URL.createObjectURL(file);
        ambientBg.style.backgroundImage = `url(${url})`;
        ambientBg.style.opacity = "0.45";
        dropzone.classList.add('hidden');
        imgBox.style.display = 'block';

        if (file.type.startsWith('video/')) {
            video.src = url;
            videoUI.style.display = 'flex';
            video.onloadedmetadata = () => { timeline.max = video.duration; video.currentTime = 0.1; };
            // 核心修改：使用 replace(url, true) 來取代 initCropper
            // 這樣在拖曳時間軸時，就不會閃爍，也不會重置裁切框位置
            video.onseeked = () => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const frameUrl = canvas.toDataURL('image/png');
                
                if (cropper) {
                    // 第二個參數 true 表示保持原有的 aspect ratio 和 crop box 尺寸/位置
                    cropper.replace(frameUrl, true);
                } else {
                    image.src = frameUrl;
                    initCropper();
                }
                updateTimeUI();
            };
        } else {
            videoUI.style.display = 'none';
            image.src = url;
            setTimeout(initCropper, 100);
        }
    }

    lockBtn.onclick = () => {
        isRatioLocked = !isRatioLocked;
        lockBtn.classList.toggle('active', isRatioLocked);
        if (!isRatioLocked) selectValue.innerText = "FREE FORM";
        else selectValue.innerText = "CUSTOM";
        updateCropperRatio();
    };

    snapBtn.onclick = () => {
        isSnap16 = !isSnap16;
        snapBtn.classList.toggle('active', isSnap16);
        if (isSnap16) applySnap16();
    };

    document.getElementById('rotateLeft').onclick = () => cropper?.rotate(-90);
    document.getElementById('flipX').onclick = () => cropper?.scaleX(cropper.getData().scaleX * -1);
    document.getElementById('flipY').onclick = () => cropper?.scaleY(cropper.getData().scaleY * -1);

    window.addEventListener('paste', (e) => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes('image') || item.type.includes('video')) { handleFile(item.getAsFile()); break; }
        }
    });

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
            if (document.activeElement.tagName === 'INPUT') return;
            e.preventDefault(); 
            performCopy();
        }
    });

    dropzone.ondblclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    async function performCopy() {
        if (!cropper) return;
        cropper.getCroppedCanvas().toBlob(async (blob) => {
            try {
                await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                showToast("COPIED TO CLIPBOARD");
            } catch (err) {
                console.error(err);
                showToast("Use Button to Copy"); 
            }
        });
    }

    document.getElementById('copyBtn').onclick = performCopy;
    document.getElementById('dlBtn').onclick = () => {
        if (!cropper) return;
        const link = document.createElement('a');
        link.download = `crop_${Date.now()}.png`;
        link.href = cropper.getCroppedCanvas().toDataURL();
        link.click();
        showToast("IMAGE SAVED");
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block'; 
        setTimeout(() => t.style.display='none', 2500);
    }

    function stepFrame(frames) {
        if (!video.src) return;
        video.pause();
        // 使用更精細的 FPS 計算，並確保不會小於 0 或大於總長度
        video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + (frames * (1/fps))));
        timeline.value = video.currentTime;
        // updateTimeUI 會在 onseeked 觸發
    }
    
    function updateTimeUI() {
        const date = new Date(0);
        date.setSeconds(video.currentTime);
        const ms = Math.floor((video.currentTime % 1) * 1000).toString().padStart(3, '0');
        timeDisplay.innerText = date.toISOString().substr(14, 5) + '.' + ms;
    }
    timeline.oninput = () => { video.currentTime = timeline.value; updateTimeUI(); };
</script>
</body>
</html>