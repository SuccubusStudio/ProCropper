<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Cropper V9.0 - Safe View</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --depth-base: #020205;
            --depth-purple: #0f0725;
            --depth-blue: #050b24;
            --glass-bg: rgba(0, 0, 0, 0.45);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.3);
            --text: rgba(255, 255, 255, 0.55);
            --text-bright: #ffffff;
            --panel-inner: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--depth-base);
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
            color: var(--text);
        }

        /* 預處理遮罩 */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .loader-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        #loader-progress {
            width: 0%;
            height: 100%;
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
            transition: width 0.1s;
        }

        .mesh-bg {
            position: fixed;
            inset: -50%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 30%, var(--depth-purple) 0, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--depth-blue) 0, transparent 50%),
                linear-gradient(135deg, #000 0%, #050512 100%);
            filter: blur(60px);
            animation: deepFlow 25s infinite alternate ease-in-out;
        }

        @keyframes deepFlow {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        #ambient-bg {
            position: absolute;
            inset: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            filter: blur(100px) saturate(1.8);
            opacity: 0;
            transition: opacity 2s ease;
        }

        #toast {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: #000;
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 800;
            font-size: 10px;
            letter-spacing: 2px;
            display: none;
            z-index: 9999;
            box-shadow: 0 15px 40px var(--accent-glow);
            text-transform: uppercase;
        }

        .app-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 15px 30px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            background: var(--glass-bg);
            box-sizing: border-box;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label {
            font-size: 8px;
            color: rgba(255,255,255,0.3);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1.5px;
        }

        .inputs-row {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--panel-inner);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            min-height: 36px;
        }

        .custom-select {
            position: relative;
            min-width: 140px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
        }
        
        .custom-select.mini {
            min-width: 80px;
        }

        .select-trigger { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .select-trigger:after {
            content: ''; border: solid var(--accent); border-width: 0 1.5px 1.5px 0;
            display: inline-block; padding: 3px; transform: rotate(45deg);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 15px);
            left: -10px; right: -10px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            display: none;
            z-index: 200;
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .custom-select.open .select-options { display: block; }
        .option { padding: 8px 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text); }
        .option:hover { background: rgba(0, 242, 255, 0.1); color: var(--accent); }
        .option.selected { color: var(--accent); font-weight: 800; }

        input { background: transparent; border: none; color: #fff; width: 45px; text-align: center; font-weight: 600; font-size: 13px; outline: none; font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button { display: none; }
        input:focus { color: var(--accent); }

        .btn-icon {
            background: rgba(255,255,255,0.06); border: none; width: 32px; height: 32px;
            border-radius: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text); transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .btn-icon.active { color: var(--accent); background: rgba(0, 242, 255, 0.15); border: 1px solid rgba(0, 242, 255, 0.2); }

        .main-stage {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #dropzone {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(0,0,0,0.2);
            user-select: none;
        }
        #dropzone.hidden { display: none; }
        
        .upload-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 40px 60px;
            border-radius: 25px;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-card:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.08); transform: translateY(-5px); }

        .img-container { width: 100%; height: 100%; display: none; }
        #image { max-width: 100%; max-height: 100%; display: block; }

        .footer-bar {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            z-index: 100;
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            background: var(--glass-bg);
            border-top: 1px solid var(--glass-border);
        }

        .video-ui {
            padding: 12px 30px;
            display: none;
            flex-direction: column;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .time-row { display: flex; align-items: center; gap: 20px; }
        .frame-display { font-family: monospace; font-size: 11px; color: var(--accent); min-width: 100px; letter-spacing: 1px; font-weight: 800; }
        input[type="range"] { flex: 1; accent-color: var(--accent); cursor: pointer; height: 4px; }

        .frame-nav { display: flex; justify-content: center; gap: 8px; }
        .btn-frame {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text); padding: 6px 16px; border-radius: 7px; font-size: 10px;
            font-weight: 800; cursor: pointer; text-transform: uppercase;
        }
        .btn-frame:hover { border-color: var(--accent); color: #fff; background: rgba(0, 242, 255, 0.1); }

        .action-row { padding: 18px 40px; display: flex; justify-content: center; gap: 15px; }
        .btn-main {
            padding: 12px 35px; border-radius: 14px; font-weight: 800; font-size: 10px;
            letter-spacing: 1.5px; text-transform: uppercase; cursor: pointer; transition: 0.3s;
        }
        .btn-copy { background: #fff; color: #000; border: none; }
        .btn-copy:hover { background: var(--accent); box-shadow: 0 10px 30px var(--accent-glow); transform: translateY(-2px); }
        .btn-dl { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid var(--glass-border); }
        .btn-dl:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); }

        .cropper-view-box { outline: 1px solid var(--accent); }
        .cropper-point { background-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .cropper-face { background-color: transparent; }
        .cropper-modal { background-color: #000; opacity: 0.6; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>
<div id="toast">ACTION COMPLETED</div>

<div id="loading-overlay">
    <div style="font-weight: 800; letter-spacing: 3px; font-size: 12px; color: #fff;">EXTRACTING FRAMES</div>
    <div class="loader-bar"><div id="loader-progress"></div></div>
    <div id="loader-text" style="font-size: 10px; opacity: 0.5;">0%</div>
</div>

<div class="app-container">
    <div id="ambient-bg"></div>

    <header class="toolbar">
        <div class="input-group">
            <label>Aspect Ratio</label>
            <div class="inputs-row">
                <div class="custom-select" id="ratioSelect">
                    <div class="select-trigger" id="selectValue">16:9 HD</div>
                    <div class="select-options">
                        <div class="option" data-value="custom">Free Form</div>
                        <div class="option" data-value="1:1">1:1 Square</div>
                        <div class="option" data-value="4:3">4:3 Classic</div>
                        <div class="option selected" data-value="16:9">16:9 HD</div>
                        <div class="option" data-value="21:9">21:9 Cinema</div>
                        <div class="option" data-value="9:16">9:16 Portrait</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>Dimensions (W / H)</label>
            <div class="inputs-row">
                <input type="number" id="aspW" value="16" step="0.1">
                <button class="btn-icon" id="swapBtn" title="Swap Width/Height">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 16l-4-4 4-4M17 8l4 4-4 4"/><path d="M3 12h18"/></svg>
                </button>
                <input type="number" id="aspH" value="9" step="0.1">
                <button class="btn-icon active" id="lockBtn" title="Lock Ratio">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg>
                </button>
            </div>
        </div>

        <div class="input-group">
            <label>Grid Snapping</label>
            <div class="inputs-row">
                <input type="number" id="pxW" placeholder="W">
                
                <!-- 網格選擇器 -->
                <div class="custom-select mini" id="gridSelect">
                    <div class="select-trigger" id="gridSelectValue">16PX</div>
                    <div class="select-options">
                        <div class="option" data-grid="0">OFF</div>
                        <div class="option" data-grid="16">16PX</div>
                        <div class="option" data-grid="32">32PX</div>
                        <div class="option" data-grid="64">64PX</div>
                        <div class="option" data-grid="128">128PX</div>
                    </div>
                </div>

                <input type="number" id="pxH" placeholder="H">
            </div>
        </div>

        <div class="input-group">
            <label>Transform</label>
            <div class="inputs-row">
                <button class="btn-icon" id="fillBtn" title="Fill (Full Image Screenshot)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M7 7l10 10M17 7l-10 10"/></svg>
                </button>
                <button class="btn-icon" id="rotateLeft" title="Rotate Left">↺</button>
                <button class="btn-icon" id="flipX" title="Flip Horizontal">↔</button>
            </div>
        </div>

        <div class="input-group">
            <label>FPS</label>
            <div class="inputs-row">
                <input type="number" id="inputFPS" value="16" style="width:30px">
            </div>
        </div>
    </header>

    <main class="main-stage">
        <div id="dropzone">
            <div class="upload-card">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <p style="font-size: 10px; letter-spacing: 2px; font-weight: 800; color: #fff;">PASTE, DRAG OR DOUBLE CLICK</p>
            </div>
        </div>
        <div class="img-container" id="imgBox">
            <img id="image">
        </div>
    </main>

    <footer class="footer-bar">
        <div class="video-ui" id="videoUI">
            <div class="time-row">
                <div class="frame-display" id="frameDisplay">FRAME: 0 / 0</div>
                <input type="range" id="frameTimeline" step="1" value="0">
            </div>
            <div class="frame-nav">
                <button class="btn-frame" onclick="stepFrame(-10)">- 10 FR</button>
                <button class="btn-frame" onclick="stepFrame(-1)">PREV FR</button>
                <button class="btn-frame" onclick="stepFrame(1)">NEXT FR</button>
                <button class="btn-frame" onclick="stepFrame(10)">+ 10 FR</button>
            </div>
        </div>
        <div class="action-row">
            <button class="btn-main btn-copy" id="copyBtn">Copy to Clipboard</button>
            <button class="btn-main btn-dl" id="dlBtn">Save Image</button>
            <input type="file" id="fileInput" hidden accept="image/*,video/mp4,video/quicktime,video/webm">
        </div>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const image = document.getElementById('image'),
          imgBox = document.getElementById('imgBox'), 
          videoUI = document.getElementById('videoUI'),
          ambientBg = document.getElementById('ambient-bg'),
          frameTimeline = document.getElementById('frameTimeline'),
          frameDisplay = document.getElementById('frameDisplay'),
          dropzone = document.getElementById('dropzone'), 
          fileInput = document.getElementById('fileInput'),
          pxW = document.getElementById('pxW'), pxH = document.getElementById('pxH'),
          aspW = document.getElementById('aspW'), aspH = document.getElementById('aspH'),
          lockBtn = document.getElementById('lockBtn'), 
          swapBtn = document.getElementById('swapBtn'),
          inputFPS = document.getElementById('inputFPS'),
          loadingOverlay = document.getElementById('loading-overlay'),
          loaderProgress = document.getElementById('loader-progress'),
          loaderText = document.getElementById('loader-text'),
          fillBtn = document.getElementById('fillBtn');

    let cropper, currentGridSize = 16, isRatioLocked = true;
    let extractedFrames = []; 
    let currentFrameIndex = 0;
    let isInternalUpdate = false;
    
    // 拖曳鎖定相關變數
    let lastPointerX = 0;
    let lastPointerY = 0;

    // --- Core Interaction Logic ---

    // 初始化預設值
    document.getElementById('gridSelectValue').innerText = "16PX";

    swapBtn.onclick = () => {
        const temp = aspW.value;
        aspW.value = aspH.value;
        aspH.value = temp;
        
        isRatioLocked = true;
        lockBtn.classList.add('active');
        updateCropperRatio();
        document.getElementById('selectValue').innerText = "CUSTOM SWAP";
    };

    [aspW, aspH].forEach(input => {
        input.addEventListener('input', () => {
            if (!cropper) return;
            isRatioLocked = true;
            lockBtn.classList.add('active');
            updateCropperRatio();
        });
    });

    [pxW, pxH].forEach(input => {
        input.addEventListener('change', () => {
            if (!cropper || isInternalUpdate) return;
            isRatioLocked = false;
            lockBtn.classList.remove('active');
            updateCropperRatio();
            const data = cropper.getData();
            cropper.setData({
                width: parseFloat(pxW.value) || data.width,
                height: parseFloat(pxH.value) || data.height
            });
        });
    });

    // 處理 Aspect Ratio 下拉選單
    document.getElementById('ratioSelect').onclick = (e) => {
        document.getElementById('ratioSelect').classList.toggle('open');
        document.getElementById('gridSelect').classList.remove('open'); // 關閉另一個
        e.stopPropagation();
    };

    document.querySelectorAll('#ratioSelect .option').forEach(option => {
        option.onclick = function() {
            const val = this.getAttribute('data-value');
            document.getElementById('selectValue').innerText = this.innerText;
            
            // UI Selected state
            document.querySelectorAll('#ratioSelect .option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');

            if (val !== "custom") {
                const [w, h] = val.split(':').map(Number);
                aspW.value = w; aspH.value = h;
                isRatioLocked = true; lockBtn.classList.add('active');
            } else {
                isRatioLocked = false; lockBtn.classList.remove('active');
            }
            updateCropperRatio();
        };
    });

    // 處理 Grid 下拉選單
    document.getElementById('gridSelect').onclick = (e) => {
        document.getElementById('gridSelect').classList.toggle('open');
        document.getElementById('ratioSelect').classList.remove('open'); // 關閉另一個
        e.stopPropagation();
    };

    document.querySelectorAll('#gridSelect .option').forEach(option => {
        option.onclick = function() {
            const val = parseInt(this.getAttribute('data-grid'));
            currentGridSize = val;
            
            document.getElementById('gridSelectValue').innerText = this.innerText;
            
            // UI Selected state
            document.querySelectorAll('#gridSelect .option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');

            // 立即應用一次對齊
            if (currentGridSize > 0) applyGridSnap();
        };
    });

    // 點擊空白處關閉選單
    window.addEventListener('click', () => {
        document.querySelectorAll('.custom-select').forEach(el => el.classList.remove('open'));
    });

    function updateCropperRatio() {
        if (cropper) {
            cropper.setAspectRatio(isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN);
        }
    }

    function getPointer(e) {
        if (e.touches && e.touches.length > 0) {
            return { x: e.touches[0].pageX, y: e.touches[0].pageY };
        }
        return { x: e.pageX, y: e.pageY };
    }

    function initCropper(sourceUrl) {
        if(cropper) cropper.destroy();
        image.src = sourceUrl;
        
        // 標記：是否為首次載入（用於控制自動縮放，避免切換 Frame 時一直縮放）
        let isFirstReady = true;

        cropper = new Cropper(image, {
            viewMode: 1, 
            dragMode: 'move', 
            autoCropArea: 0.8,
            background: false,
            responsive: true,
            restore: false,
            aspectRatio: isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN,
            
            ready() {
                // --- 智能縮放邏輯：載入時自動縮小至 60% 並居中 (V9.0 Update) ---
                if (isFirstReady) {
                    const containerData = this.cropper.getContainerData();
                    const canvasData = this.cropper.getCanvasData();

                    // 使用 0.6 (60%) 確保四周留有足夠的安全邊距
                    const newWidth = canvasData.width * 0.6;
                    const newHeight = canvasData.height * 0.6;

                    // 計算居中位置
                    const newLeft = (containerData.width - newWidth) / 2;
                    const newTop = (containerData.height - newHeight) / 2;

                    this.cropper.setCanvasData({
                        width: newWidth,
                        height: newHeight,
                        left: newLeft,
                        top: newTop
                    });
                    
                    // 標記已完成初始化縮放
                    isFirstReady = false;
                }
            },

            cropstart(e) {
                const ptr = getPointer(e.detail.originalEvent);
                lastPointerX = ptr.x;
                lastPointerY = ptr.y;
            },

            cropmove(e) {
                // --- Step Dragging ---
                if (currentGridSize > 0) {
                    const ptr = getPointer(e.detail.originalEvent);
                    const dx = Math.abs(ptr.x - lastPointerX);
                    const dy = Math.abs(ptr.y - lastPointerY);

                    if (dx < currentGridSize && dy < currentGridSize) {
                        e.preventDefault(); 
                    } else {
                        if (dx >= currentGridSize) lastPointerX = ptr.x;
                        if (dy >= currentGridSize) lastPointerY = ptr.y;
                    }
                }
            },

            crop(e) {
                if (document.activeElement !== pxW && document.activeElement !== pxH) {
                    isInternalUpdate = true;
                    pxW.value = Math.round(e.detail.width); 
                    pxH.value = Math.round(e.detail.height);
                    isInternalUpdate = false;
                }
            },
            cropend() {
                if (currentGridSize > 0) applyGridSnap();
            }
        });
    }

    async function handleFile(file) {
        if (!file) return;
        
        extractedFrames.forEach(url => URL.revokeObjectURL(url));
        extractedFrames = [];
        currentFrameIndex = 0;

        if (file.type.startsWith('video/')) {
            loadingOverlay.style.display = 'flex';
            await extractFramesFromVideo(file);
            loadingOverlay.style.display = 'none';
            
            if (extractedFrames.length > 0) {
                videoUI.style.display = 'flex';
                imgBox.style.display = 'block';
                dropzone.classList.add('hidden');
                
                frameTimeline.max = extractedFrames.length - 1;
                frameTimeline.value = 0;
                updateFrameUI();
                initCropper(extractedFrames[0]);
                
                ambientBg.style.backgroundImage = `url(${extractedFrames[0]})`;
                ambientBg.style.opacity = "0.3";
            }
        } else {
            videoUI.style.display = 'none';
            const url = URL.createObjectURL(file);
            imgBox.style.display = 'block';
            dropzone.classList.add('hidden');
            initCropper(url);
            ambientBg.style.backgroundImage = `url(${url})`;
            ambientBg.style.opacity = "0.3";
        }
    }

    async function extractFramesFromVideo(file) {
        return new Promise((resolve) => {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playsInline = true;

            video.onloadedmetadata = async () => {
                const fps = parseFloat(inputFPS.value) || 16;
                const duration = video.duration;
                const totalFrames = Math.floor(duration * fps);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                for (let i = 0; i < totalFrames; i++) {
                    const time = i / fps;
                    video.currentTime = time;
                    
                    await new Promise(r => {
                        const onSeeked = () => {
                            video.removeEventListener('seeked', onSeeked);
                            r();
                        };
                        video.addEventListener('seeked', onSeeked);
                    });

                    ctx.drawImage(video, 0, 0);
                    
                    await new Promise(r => {
                        canvas.toBlob(blob => {
                            const url = URL.createObjectURL(blob);
                            extractedFrames.push(url);
                            const progress = Math.round((i / totalFrames) * 100);
                            loaderProgress.style.width = progress + '%';
                            loaderText.innerText = progress + '%';
                            r();
                        }, 'image/jpeg', 0.9);
                    });
                }
                URL.revokeObjectURL(video.src);
                resolve();
            };
        });
    }

    function stepFrame(dir) {
        if (extractedFrames.length === 0) return;
        currentFrameIndex = Math.max(0, Math.min(extractedFrames.length - 1, currentFrameIndex + dir));
        frameTimeline.value = currentFrameIndex;
        updateFrameUI();
        if (cropper) cropper.replace(extractedFrames[currentFrameIndex], true);
    }

    function updateFrameUI() {
        frameDisplay.innerText = `FRAME: ${currentFrameIndex + 1} / ${extractedFrames.length}`;
    }

    frameTimeline.oninput = () => {
        currentFrameIndex = parseInt(frameTimeline.value);
        updateFrameUI();
        if (cropper) cropper.replace(extractedFrames[currentFrameIndex], true);
    };

    function applyGridSnap() {
        if (!cropper || currentGridSize === 0) return;
        const data = cropper.getData();
        
        let newW = Math.round(data.width / currentGridSize) * currentGridSize;
        let newX = Math.round(data.x / currentGridSize) * currentGridSize;
        let newY = Math.round(data.y / currentGridSize) * currentGridSize;
        
        let newH = isRatioLocked 
            ? Math.round((newW / (parseFloat(aspW.value)/parseFloat(aspH.value))) / currentGridSize) * currentGridSize 
            : Math.round(data.height / currentGridSize) * currentGridSize;
            
        if (isRatioLocked) {
             newH = newW / (parseFloat(aspW.value)/parseFloat(aspH.value));
        }

        cropper.setData({ x: newX, y: newY, width: newW, height: newH });
    }

    lockBtn.onclick = () => {
        isRatioLocked = !isRatioLocked;
        lockBtn.classList.toggle('active', isRatioLocked);
        updateCropperRatio();
    };

    fillBtn.onclick = () => {
        if (!cropper) return;
        isRatioLocked = false;
        lockBtn.classList.remove('active');
        document.getElementById('selectValue').innerText = "FREE FORM";
        updateCropperRatio();
        const imageData = cropper.getImageData();
        cropper.setData({
            x: 0,
            y: 0,
            width: imageData.naturalWidth,
            height: imageData.naturalHeight
        });
        showToast("FILLED TO CANVAS");
    };

    document.getElementById('rotateLeft').onclick = () => cropper?.rotate(-90);
    document.getElementById('flipX').onclick = () => cropper?.scaleX(cropper.getData().scaleX * -1);

    async function performCopy() {
        if (!cropper) return;
        cropper.getCroppedCanvas().toBlob(async (blob) => {
            try {
                await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                showToast("COPIED TO CLIPBOARD");
            } catch (err) { showToast("COPY FAILED"); }
        });
    }

    document.getElementById('copyBtn').onclick = performCopy;
    document.getElementById('dlBtn').onclick = () => {
        if (!cropper) return;
        const link = document.createElement('a');
        link.download = `crop_frame_${currentFrameIndex + 1}.png`;
        link.href = cropper.getCroppedCanvas().toDataURL();
        link.click();
        showToast("IMAGE SAVED");
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block'; 
        setTimeout(() => t.style.display='none', 2000);
    }

    dropzone.ondblclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);
    window.addEventListener('paste', (e) => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes('image') || item.type.includes('video')) {
                handleFile(item.getAsFile()); break;
            }
        }
    });

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
            if (document.activeElement.tagName === 'INPUT') return;
            e.preventDefault();
            performCopy();
            return;
        }

        if (videoUI.style.display === 'flex') {
            if (e.key === 'ArrowRight') stepFrame(1);
            if (e.key === 'ArrowLeft') stepFrame(-1);
        }
    });
</script>
</body>
</html>