<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Cropper V8.0 - Video Mastery & Glass Aesthetics</title>
    <!-- 引入 Cropper.js 樣式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --depth-base: #020205;
            --depth-purple: #0f0725;
            --depth-blue: #050b24;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.3);
            --text: rgba(255, 255, 255, 0.55);
            --text-bright: #ffffff;
            --panel-inner: rgba(0, 0, 0, 0.45);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--depth-base);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            color: var(--text);
            box-sizing: border-box;
        }

        /* 基礎動態背景 */
        .mesh-bg {
            position: fixed;
            inset: -50%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 30%, var(--depth-purple) 0, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--depth-blue) 0, transparent 50%),
                linear-gradient(135deg, #000 0%, #050512 100%);
            filter: blur(60px);
            animation: deepFlow 25s infinite alternate ease-in-out;
        }

        @keyframes deepFlow {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        #ambient-bg {
            position: absolute;
            inset: -10%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            filter: blur(120px) saturate(2);
            opacity: 0;
            transition: opacity 2s ease;
        }

        #toast {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: #000;
            padding: 12px 28px;
            border-radius: 40px;
            font-weight: 800;
            font-size: 10px;
            letter-spacing: 3px;
            display: none;
            z-index: 9999;
            box-shadow: 0 15px 40px var(--accent-glow);
            text-transform: uppercase;
        }

        .app-container {
            width: 100%;
            max-width: 1100px;
            height: 100%;
            max-height: 800px;
            border-radius: 40px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.01);
            box-shadow: 0 50px 120px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* 工具列 */
        .toolbar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 20px 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            background: rgba(0, 0, 0, 0.4);
            box-sizing: border-box;
        }

        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label {
            font-size: 8px;
            color: rgba(255,255,255,0.25);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 3px;
        }

        .inputs-row {
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--panel-inner);
            padding: 5px 10px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.06);
            transition: 0.3s;
            min-height: 34px;
            box-sizing: border-box;
        }

        /* 自定義下拉選單樣式 */
        .custom-select {
            position: relative;
            min-width: 140px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            user-select: none;
        }
        .select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 5px;
        }
        .select-trigger:after {
            content: '';
            border: solid var(--accent);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            margin-left: 10px;
            transition: 0.3s;
        }
        .custom-select.open .select-trigger:after {
            transform: rotate(-135deg);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 12px);
            left: -10px;
            right: -10px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            overflow: hidden;
            display: none;
            z-index: 200;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            padding: 8px 0;
        }
        .custom-select.open .select-options { display: block; animation: selectFade 0.2s ease-out; }
        
        @keyframes selectFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .option {
            padding: 10px 20px;
            color: rgba(255,255,255,0.6);
            transition: 0.2s;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .option:hover { background: rgba(0, 242, 255, 0.1); color: var(--accent); }
        .option.selected { color: var(--accent); font-weight: 800; background: rgba(0, 242, 255, 0.05); }

        input {
            background: transparent;
            border: none;
            color: var(--text-bright);
            padding: 6px;
            font-size: 13px;
            outline: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; width: 45px; text-align: center; }

        .btn-icon {
            background: rgba(255,255,255,0.04);
            color: var(--text);
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.12); color: #fff; }
        .btn-icon.active { color: var(--accent); background: rgba(0, 242, 255, 0.12); border: 1px solid rgba(0, 242, 255, 0.2); }

        .main-stage {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #dropzone {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(0,0,0,0.1);
        }
        #dropzone.hidden { opacity: 0; pointer-events: none; }
        
        .upload-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 50px 80px;
            border-radius: 32px;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-card:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); }

        .img-container { width: 100%; height: 100%; display: none; justify-content: center; align-items: center; }
        #image { max-width: 100%; display: block; }

        /* 底部工具欄與影片控制 */
        .footer-bar {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            z-index: 100;
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid var(--glass-border);
        }

        .video-ui {
            padding: 12px 30px;
            display: none; /* 預設隱藏，影片載入後顯示 */
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .time-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .time-display {
            font-family: monospace;
            font-size: 11px;
            color: var(--accent);
            min-width: 90px;
            text-shadow: 0 0 10px var(--accent-glow);
        }
        input[type="range"] {
            flex: 1;
            accent-color: var(--accent);
            height: 4px;
            cursor: pointer;
        }

        .frame-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .btn-frame {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-frame:hover { background: rgba(255,255,255,0.1); color: var(--text-bright); border-color: var(--accent); }

        .action-row { padding: 20px 36px; display: flex; justify-content: center; gap: 20px; }
        .btn-main {
            padding: 14px 38px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .btn-copy { background: var(--text-bright); color: #000; }
        .btn-copy:hover { transform: translateY(-2px); background: var(--accent); box-shadow: 0 15px 35px var(--accent-glow); }
        .btn-dl { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); border-color: var(--glass-border); }

        /* Cropper UI */
        .cropper-view-box { outline: 1px solid var(--accent); }
        .cropper-point { background-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .cropper-modal { opacity: 0.5 !important; background-color: #000 !important; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>
<div id="toast">ACTION COMPLETED</div>

<div class="app-container">
    <div id="ambient-bg"></div>

    <header class="toolbar">
        <div class="input-group">
            <label>比例預設</label>
            <div class="inputs-row">
                <div class="custom-select" id="ratioSelect">
                    <div class="select-trigger" id="selectValue">16:9 HD</div>
                    <div class="select-options">
                        <div class="option" data-value="custom">Free Form</div>
                        <div class="option" data-value="1:1">1:1 Square</div>
                        <div class="option" data-value="4:3">4:3 Classic</div>
                        <div class="option selected" data-value="16:9">16:9 HD</div>
                        <div class="option" data-value="21:9">21:9 Cinema</div>
                        <div class="option" data-value="9:16">9:16 Portrait</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>精準比例</label>
            <div class="inputs-row">
                <input type="number" id="aspW" value="16" step="0.1">
                <button class="btn-icon active" id="lockBtn">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg>
                </button>
                <input type="number" id="aspH" value="9" step="0.1">
            </div>
        </div>

        <div class="input-group">
            <label>像素對齊</label>
            <div class="inputs-row">
                <input type="number" id="pxW" placeholder="W" readonly>
                <button class="btn-icon" id="snapBtn">
                    <span style="font-size:9px;font-weight:900">16</span>
                </button>
                <input type="number" id="pxH" placeholder="H" readonly>
            </div>
        </div>

        <div class="input-group">
            <label>畫布</label>
            <div class="inputs-row">
                <button class="btn-icon" id="rotateLeft">↺</button>
                <button class="btn-icon" id="flipX">↔</button>
            </div>
        </div>
    </header>

    <main class="main-stage">
        <div id="dropzone">
            <div class="upload-card">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <p>PASTE, DRAG OR CLICK</p>
            </div>
        </div>
        <div class="img-container" id="imgBox">
            <img id="image">
        </div>
        <video id="videoSource" style="display:none;"></video>
    </main>

    <footer class="footer-bar">
        <!-- 影片控制 UI：現在適配玻璃風格 -->
        <div class="video-ui" id="videoUI">
            <div class="time-row">
                <div class="time-display" id="timeDisplay">00:00.000</div>
                <input type="range" id="timeline" step="0.001" value="0">
            </div>
            <div class="frame-nav">
                <button class="btn-frame" onclick="stepFrame(-10)">-10幀</button>
                <button class="btn-frame" onclick="stepFrame(-1)">上一幀</button>
                <button class="btn-frame" onclick="stepFrame(1)">下一幀</button>
                <button class="btn-frame" onclick="stepFrame(10)">+10幀</button>
            </div>
        </div>
        <div class="action-row">
            <button class="btn-main btn-copy" id="copyBtn">複製到剪貼簿</button>
            <button class="btn-main btn-dl" id="dlBtn">儲存 PNG 圖片</button>
            <input type="file" id="fileInput" hidden accept="image/*,video/mp4,video/quicktime">
        </div>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const video = document.getElementById('videoSource'), 
          image = document.getElementById('image'),
          imgBox = document.getElementById('imgBox'), 
          videoUI = document.getElementById('videoUI'),
          ambientBg = document.getElementById('ambient-bg'),
          timeline = document.getElementById('timeline'),
          timeDisplay = document.getElementById('timeDisplay'),
          dropzone = document.getElementById('dropzone'), 
          fileInput = document.getElementById('fileInput'),
          pxW = document.getElementById('pxW'), pxH = document.getElementById('pxH'),
          aspW = document.getElementById('aspW'), aspH = document.getElementById('aspH'),
          lockBtn = document.getElementById('lockBtn'), 
          snapBtn = document.getElementById('snapBtn'),
          ratioSelect = document.getElementById('ratioSelect'),
          selectValue = document.getElementById('selectValue');

    let cropper, isSnap16 = false, isRatioLocked = true;
    const fps = 30; // 預設 30fps

    // 下拉選單邏輯
    ratioSelect.addEventListener('click', (e) => {
        ratioSelect.classList.toggle('open');
        e.stopPropagation();
    });

    document.querySelectorAll('.option').forEach(option => {
        option.addEventListener('click', function() {
            const val = this.getAttribute('data-value');
            selectValue.innerText = this.innerText;
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');

            if (val === "custom") {
                isRatioLocked = false;
                lockBtn.classList.remove('active');
            } else {
                const [w, h] = val.split(':').map(Number);
                aspW.value = w; aspH.value = h;
                isRatioLocked = true;
                lockBtn.classList.add('active');
            }
            if (cropper) cropper.setAspectRatio(isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN);
        });
    });

    window.addEventListener('click', () => ratioSelect.classList.remove('open'));

    // 影片步進功能
    function stepFrame(frames) {
        if (!video.src) return;
        video.pause();
        video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + (frames * (1/fps))));
        timeline.value = video.currentTime;
        updateTimeUI();
    }

    function updateTimeUI() {
        const m = Math.floor(video.currentTime / 60).toString().padStart(2, '0');
        const s = (video.currentTime % 60).toFixed(3).padStart(6, '0');
        timeDisplay.innerText = `${m}:${s}`;
    }

    function initCropper() {
        if(cropper) cropper.destroy();
        cropper = new Cropper(image, {
            viewMode: 1, dragMode: 'move', autoCropArea: 0.65, center: true, background: false, responsive: true,
            aspectRatio: isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN,
            crop(e) { pxW.value = Math.round(e.detail.width); pxH.value = Math.round(e.detail.height); },
            cropend() { if (isSnap16) applySnap16(); }
        });
    }

    function applySnap16() {
        if (!cropper) return;
        const data = cropper.getData();
        let newW = Math.round(data.width / 16) * 16;
        let newH = isRatioLocked 
            ? Math.round((newW / (parseFloat(aspW.value)/parseFloat(aspH.value))) / 16) * 16 
            : Math.round(data.height / 16) * 16;
        cropper.setData({ width: newW, height: newH });
    }

    function handleFile(file) {
        if (!file) return;
        const url = URL.createObjectURL(file);
        ambientBg.style.backgroundImage = `url(${url})`;
        ambientBg.style.opacity = "0.45";
        dropzone.classList.add('hidden');
        imgBox.style.display = 'flex';

        if (file.type.startsWith('video/')) {
            video.src = url;
            videoUI.style.display = 'flex';
            video.onloadedmetadata = () => {
                timeline.max = video.duration;
                video.currentTime = 0.1;
            };
            video.onseeked = () => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                image.src = canvas.toDataURL('image/png');
                initCropper();
                updateTimeUI();
            };
        } else {
            videoUI.style.display = 'none';
            image.src = url;
            setTimeout(initCropper, 150);
        }
    }

    lockBtn.onclick = () => {
        isRatioLocked = !isRatioLocked;
        lockBtn.classList.toggle('active', isRatioLocked);
        if (!isRatioLocked) selectValue.innerText = "FREE FORM";
        if (cropper) cropper.setAspectRatio(isRatioLocked ? parseFloat(aspW.value)/parseFloat(aspH.value) : NaN);
    };

    snapBtn.onclick = () => {
        isSnap16 = !isSnap16;
        snapBtn.classList.toggle('active', isSnap16);
        if (isSnap16) applySnap16();
    };

    document.getElementById('rotateLeft').onclick = () => cropper?.rotate(-90);
    document.getElementById('flipX').onclick = () => cropper?.scaleX(cropper.getData().scaleX * -1);

    // 增強貼上邏輯，支援影片
    window.addEventListener('paste', (e) => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes('image') || item.type.includes('video')) {
                handleFile(item.getAsFile());
                break;
            }
        }
    });

    dropzone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    async function performCopy() {
        if (!cropper) return;
        cropper.getCroppedCanvas().toBlob(async (blob) => {
            try {
                if (!navigator.clipboard || !window.ClipboardItem) throw new Error();
                await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                showToast("COPIED TO CLIPBOARD");
            } catch (err) { showToast("RESTRICTED: PLEASE DOWNLOAD"); }
        });
    }

    document.getElementById('copyBtn').onclick = performCopy;
    document.getElementById('dlBtn').onclick = () => {
        if (!cropper) return;
        const link = document.createElement('a');
        link.download = `crop_${Date.now()}.png`;
        link.href = cropper.getCroppedCanvas().toDataURL();
        link.click();
        showToast("IMAGE SAVED");
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block'; 
        setTimeout(() => t.style.display='none', 3000);
    }

    window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') {
            if (cropper) { e.preventDefault(); performCopy(); }
        }
    });

    timeline.oninput = () => { video.currentTime = timeline.value; updateTimeUI(); };
</script>
</body>
</html>